# CVE-2022-26923 
## Micosoft Active Directory Certificate Service
Vulnerability in Microsoft's Active Directory Certificate Service that allows any AD user to escalate their privileges to Domain Admin.

Username : thm  
Password : Password1@  
Domain: lunar.eruca.com  
Machine ip : 10.10.41.103  

# CVE-2022-26923 Explained
## Client Authentication
Certificate Templates are convenient to allow users and systems to enrol for certificates. Certificates have many use case in the network.  

CVE-2022-26923 - Template misconfiguration
- Focus is on the Client Authentication use case  


Client Authentication allows the owner of the certficiate to use it to verify their own identity in AD for authentication purposes.
- Authentication occurs through Kerberos
- Valid certificate that has Client Authentication EKU > We can interface with AD CS + Key Distribution Centre to request a Kerberos TGT that can be used for further authentication

Attacker:
- Generate a TGT to impersonate another user
- Aim is to be able to modify Subject Alternative Name attribute of the certificate request to point to someone else (that has more permissions to perform privilege escalation)

TGT:
- Kerberos
- Ticket Granting Ticket serves as a user's proof of authentication
- Allows a user to request service tickets from KDC
- Used to connected services across the network

## Default Certificate Templates
When AD CS is installed in an environment, 2 certificate templates are made available for requests that support Client Authentication.

User Certificate Template
- Can be requested by any user that belongs to the Domain User group

    - User Template is not vulnerable by default
    - Request a certificate based on the User template, the User Principal Name of the user account will be embedded in the SAN that can be used for identification
    - UPNs must be unique, unable to modify UPN
    - Unable to alter the SAN value in the certificate signing request, we cannot impersonate another use by specifying their UPN  


Machine Certificate Template
- Can be requested by any host that belongs to the Domain Computer group

	- Computer accounts do not have UPN
	- Instead of using UPN for authentication > machine template uses DNS name of the machine for identification + authentication
    - When a certificate is requested for a machine through the Machine template, AD CS embeds the machine DNS name into the SAN (used for authentication)

## Default Domain User Privileges

- Any user who is a member of Authenticated User group (all AD accounts) can enrol up to 10 new machines on the domain
- Used in organizations to allow users to BYOD and enrol for use on domain
- Enrol a new host in AD > assigned as the owner of that host > permissions over the AD Object associated with that host

2 permissions cause an issue here:

Validate write to DNS hostname
- Permission allows us to update DNS hostname of AD Object associated with host

Validate write to Service Principal Name
- Permission allows us to update SPN of AD Object associated with host  

    - SPNs are used by Kerberos authentication to associate a service instance with a service logon account
    - Computer AD Object receives SPNs associated with their name to allow for Kerberos authentication
    - SPNs must be unique > 2 AD Objects are not allowed to have the same SPN

## Putting it all together
Using these configurations:
- The default AD CS machine certificate template
- The default ability to enrol a new machine
- Default permissions assigned on the creator Computer AD Object

We potentially have privilege escalation.

1. Compromise the credentials of a low-privileged AD user
2. Use those credentials to enrol a new host on domain
3. Alter DNS hostname attribute of Computer AD Object to that of a privileged host (Domain Controller)
4. Remove SPN attribute to bypass unique SPN conflict issue
5. Request a Machine certificate using default template
Perform Kerberos authentication with the received template