# Exploiting Certificates
## AD Certificate Services
- Microsoft's Public Key Infrastructure implementation
- AD provides a level of trust in an organization, it can be used as a Certificate Authority to prove and delegate trust
- AD CS is a privileged function, usually runs on selected Domain Controllers
- Normal user accounts are unable to interact with the service directly

### PKI
- Public Key Infrastructure is a system that manages certificates and public key encryption

### AD CS
- Active Directory Certificate Services
- Microsoft's PKI implementation
- Runs on Domain Controllers

### Certificate Authority
- Is a PKI that issues certificates

### Certificate Template
- Collection of settings and predefined rules that determine the format and content of certificates issued by the CA
- Admin of AD CS can create several templates that can allow any user with relevant permissions to request a certificate themselves

### Certificate Signing Request
- Message sent to a Certificate Authority to request a signed certificate

## Finding Vulnerable Certificate Templates
From Exploiting GPOs task, members of `IT Support` group now have admin and RDP permission on THMSERVER2.
- RDP into THMSERVER2 using account from `IT Support` group  

Use `certutil` to find vulnerable templates

<pre>certutil -Template -v > VulnTemplate.txt</pre>

A certificate template is deemed misconfigured if a combinatin of parameter values becomes poisonous, allowing the requestor to perform privilege escalation.  

We are looking for a template with the following parameter combination:
- `Client_Authentication` Certificate can be used for Client Authentication  
- `CT_FLAG_ENROLLEE_SUPPLIES_SUBJECT` Certificate template allows us to specify the Subject Alternative Name  
- `CTPRIVATEKEY_FLAG_EXPORTABLE_KEY` Certificate will be exportable with the private key  
- `Certificate_Permissions` We have the required permissions to use the certificate template

[Title](../../Images/VulnTemplate.txt)

From the file above, Template[32] is the vulnerable template:
- Machine account THMSERVER2 can issue a CSR template that allows us to specify SAN and can be used for client authentication